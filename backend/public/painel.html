<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Pedidos - Mickey Lanches</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <header class="bg-red-600 text-white py-4 px-6 flex justify-between items-center shadow">
    <h1 class="text-2xl font-bold">üçî Mickey Lanches ‚Äî Painel</h1>
    <div class="flex gap-3 items-center">
      <p id="caixa-status" class="font-semibold"></p>
      <button id="abrir-caixa" class="bg-green-600 px-4 py-2 rounded hover:bg-green-700">Abrir Caixa</button>
      <button id="fechar-caixa" class="bg-yellow-500 px-4 py-2 rounded hover:bg-yellow-600 hidden">Fechar Caixa</button>
      <button id="novo-pedido-btn" class="bg-blue-500 px-4 py-2 rounded hover:bg-blue-600">Novo Pedido</button>
    </div>
  </header>

  <main class="max-w-6xl mx-auto py-6 px-4">
    <h2 class="text-xl font-bold mb-4">üì¶ Pedidos</h2>
    <div id="pedidos-container" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
  </main>

  <footer class="text-center text-sm text-gray-600 py-3 border-t mt-6">
    Sistema de Delivery ¬© 2025 - Mickey Lanches
  </footer>

  <!-- Modal Novo Pedido -->
  <div id="novo-pedido-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-start overflow-auto pt-10">
    <div class="bg-white rounded shadow max-w-3xl w-full p-6 relative">
      <button id="fechar-modal" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700">‚úñ</button>
      <h2 class="text-xl font-bold mb-4">üìù Novo Pedido</h2>
      <form id="pedido-form" class="space-y-4">
        <div>
          <label class="block font-semibold mb-1">Nome do Cliente</label>
          <input type="text" id="customer_name" class="w-full border rounded px-3 py-2" required />
        </div>

        <div>
          <label class="block font-semibold mb-1">Telefone</label>
          <input type="text" id="customer_phone" class="w-full border rounded px-3 py-2" required />
        </div>

        <div>
          <label class="block font-semibold mb-1">Tipo de Pedido</label>
          <select id="tipo_pedido" class="w-full border rounded px-3 py-2" required>
            <option value="retirada">Retirada no Balc√£o</option>
            <option value="entrega">Entrega</option>
          </select>
        </div>

        <div id="endereco-fields" class="space-y-2 hidden">
          <div>
            <label class="block font-semibold mb-1">Rua</label>
            <input type="text" id="rua" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block font-semibold mb-1">N√∫mero</label>
            <input type="text" id="numero" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block font-semibold mb-1">Bairro</label>
            <input type="text" id="bairro" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block font-semibold mb-1">Complemento</label>
            <input type="text" id="complemento" class="w-full border rounded px-3 py-2" />
          </div>
        </div>

        <div>
          <label class="block font-semibold mb-1">Itens do Pedido</label>
          <textarea id="items" class="w-full border rounded px-3 py-2" placeholder='Ex: [{"name":"X-Burger","quantity":2},{"name":"Coca-Cola","quantity":1}]' required></textarea>
          <small class="text-gray-500">Formato JSON: [{"name":"Produto","quantity":1}]</small>
        </div>

        <div>
          <label class="block font-semibold mb-1">Observa√ß√µes</label>
          <textarea id="observations" class="w-full border rounded px-3 py-2"></textarea>
        </div>

        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Finalizar Pedido</button>
      </form>
    </div>
  </div>

  <script>
    const pedidosContainer = document.getElementById("pedidos-container");
    const caixaStatus = document.getElementById("caixa-status");
    const abrirCaixaBtn = document.getElementById("abrir-caixa");
    const fecharCaixaBtn = document.getElementById("fechar-caixa");

    const novoPedidoBtn = document.getElementById("novo-pedido-btn");
    const novoPedidoModal = document.getElementById("novo-pedido-modal");
    const fecharModal = document.getElementById("fechar-modal");

    const tipoPedido = document.getElementById("tipo_pedido");
    const enderecoFields = document.getElementById("endereco-fields");
    const form = document.getElementById("pedido-form");

    const API = "http://localhost:3001/api";

    async function atualizarStatusCaixa() {
      const res = await fetch(`${API}/caixa/status`);
      const caixa = await res.json();

      if (caixa.aberto) {
        caixaStatus.innerHTML = "üü¢ Caixa aberto desde: " + new Date(caixa.aberto_em).toLocaleString("pt-BR");
        abrirCaixaBtn.classList.add("hidden");
        fecharCaixaBtn.classList.remove("hidden");
        novoPedidoBtn.classList.remove("hidden");
      } else {
        caixaStatus.innerHTML = "üî¥ Caixa fechado";
        abrirCaixaBtn.classList.remove("hidden");
        fecharCaixaBtn.classList.add("hidden");
        novoPedidoBtn.classList.add("hidden");
      }
    }

    async function abrirCaixa() {
      await fetch(`${API}/caixa/abrir`, { method: "POST" });
      Swal.fire("Caixa aberto!", "Pronto para receber pedidos.", "success");
      atualizarStatusCaixa();
      carregarPedidos();
    }

    async function fecharCaixa() {
      const confirm = await Swal.fire({
        title: "Deseja fechar o caixa?",
        text: "Ser√° gerado o relat√≥rio em PDF e todos os pedidos ser√£o limpos.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Sim, fechar",
        cancelButtonText: "Cancelar"
      });
      if (!confirm.isConfirmed) return;

      const res = await fetch(`${API}/caixa/fechar`, { method: "POST" });
      const data = await res.json();

      if (data.success) {
        Swal.fire({
          title: "Caixa fechado!",
          html: `Relat√≥rio gerado:<br><a href="${data.relatorio}" target="_blank" class="text-blue-600 underline">Baixar PDF</a>`,
          icon: "success"
        });
        carregarPedidos();
        atualizarStatusCaixa();
      }
    }

    async function carregarPedidos() {
      const res = await fetch(`${API}/pedidos`);
      const pedidos = await res.json();

      pedidosContainer.innerHTML = "";
      if (!pedidos.length) {
        pedidosContainer.innerHTML = "<p class='text-gray-500 text-center col-span-3'>Nenhum pedido por enquanto...</p>";
        return;
      }

      pedidos.forEach(p => {
        const div = document.createElement("div");
        div.className = "bg-white rounded shadow p-4 border border-gray-200 flex flex-col justify-between";

        div.innerHTML = `
          <div>
            <p class="font-bold text-lg mb-1">üë§ ${p.customer_name}</p>
            <p class="text-sm text-gray-600">üì± ${p.customer_phone}</p>
            <p class="text-sm">üí∞ R$ ${p.total.toFixed(2)}</p>
            <p class="text-sm">üïí ${new Date(p.created_at).toLocaleTimeString("pt-BR")}</p>
            <p class="text-sm mt-2">üìù <strong>Status:</strong> <span class="font-semibold">${p.status}</span></p>
            <p class="text-sm mt-2 text-gray-700">üõí <strong>Itens:</strong> ${JSON.parse(p.items).map(i => i.name + " x" + i.quantity).join(", ")}</p>
            ${p.observations ? `<p class="text-sm mt-2 text-gray-700">üóíÔ∏è ${p.observations}</p>` : ""}
            ${p.tipo_pedido === "entrega" && p.endereco ? `<p class="text-sm mt-1 text-gray-600">üìç ${p.endereco.rua}, ${p.endereco.numero}, ${p.endereco.bairro}${p.endereco.complemento ? ", " + p.endereco.complemento : ""}</p>` : ""}
          </div>
          <div class="flex justify-between mt-4">
            <button class="bg-yellow-500 text-white px-2 py-1 rounded text-sm" onclick="mudarStatus(${p.id}, 'em preparo', true)">Em Preparo</button>
            <button class="bg-blue-500 text-white px-2 py-1 rounded text-sm" onclick="mudarStatus(${p.id}, 'saiu pra entrega', true)">Saiu</button>
            <button class="bg-green-600 text-white px-2 py-1 rounded text-sm" onclick="mudarStatus(${p.id}, 'finalizado')">Finalizado</button>
            <button class="bg-gray-500 text-white px-2 py-1 rounded text-sm" onclick="imprimirPedido(${JSON.stringify(p).replace(/"/g, '&quot;')})">Imprimir</button>
          </div>
        `;

        pedidosContainer.appendChild(div);
      });
    }

    async function mudarStatus(id, status, imprimir=false) {
      const res = await fetch(`${API}/pedidos/${id}/status`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status })
      });
      const pedidoAtualizado = await res.json();

      if (imprimir) imprimirPedido(pedidoAtualizado);

      Swal.fire("Status atualizado!", "O cliente ver√° a atualiza√ß√£o em tempo real.", "success");
      carregarPedidos();
    }

    function imprimirPedido(pedido) {
      const win = window.open("", "_blank");
      win.document.write("<h1 style='text-align:center'>üçî Mickey Lanches</h1>");
      win.document.write(`<p><strong>Cliente:</strong> ${pedido.customer_name}</p>`);
      win.document.write(`<p><strong>Telefone:</strong> ${pedido.customer_phone}</p>`);
      win.document.write(`<p><strong>Tipo de Pedido:</strong> ${pedido.tipo_pedido}</p>`);

      if (pedido.tipo_pedido === "entrega" && pedido.endereco) {
        win.document.write(`<p><strong>Endere√ßo:</strong> ${pedido.endereco.rua}, ${pedido.endereco.numero}, ${pedido.endereco.bairro}${pedido.endereco.complemento ? ", " + pedido.endereco.complemento : ""}</p>`);
      }

      win.document.write(`<p><strong>Status:</strong> ${pedido.status}</p>`);
      win.document.write(`<p><strong>Itens:</strong></p><ul>`);
      JSON.parse(pedido.items).forEach(i => {
        win.document.write(`<li>${i.name} x ${i.quantity}</li>`);
      });
      win.document.write("</ul>");
      if (pedido.observations) win.document.write(`<p><strong>Observa√ß√µes:</strong> ${pedido.observations}</p>`);
      win.document.write(`<p><strong>Total:</strong> R$ ${pedido.total.toFixed(2)}</p>`);
      win.document.write(`<p><strong>Data/Hora:</strong> ${new Date(pedido.created_at).toLocaleString("pt-BR")}</p>`);
      win.document.close();
      win.print();
    }

    // Eventos do modal
    novoPedidoBtn.addEventListener("click", () => {
      novoPedidoModal.classList.remove("hidden");
      novoPedidoModal.classList.add("flex");
    });

    fecharModal.addEventListener("click", () => {
      novoPedidoModal.classList.add("hidden");
      novoPedidoModal.classList.remove("flex");
      form.reset();
      enderecoFields.classList.add("hidden");
    });

    tipoPedido.addEventListener("change", () => {
      if (tipoPedido.value === "entrega") enderecoFields.classList.remove("hidden");
      else enderecoFields.classList.add("hidden");
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const pedidoData = {
        customer_name: document.getElementById("customer_name").value,
        customer_phone: document.getElementById("customer_phone").value,
        tipo_pedido: tipoPedido.value,
        endereco: tipoPedido.value === "entrega" ? {
          rua: document.getElementById("rua").value,
          numero: document.getElementById("numero").value,
          bairro: document.getElementById("bairro").value,
          complemento: document.getElementById("complemento").value
        } : null,
        items: document.getElementById("items").value,
        observations: document.getElementById("observations").value,
      };

      try {
        const res = await fetch(`${API}/pedidos`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(pedidoData)
        });

        if (!res.ok) throw new Error("Erro ao criar pedido");

        await res.json();

        Swal.fire("Pedido criado!", "O pedido foi adicionado ao painel.", "success");

        // Atualiza o painel com a mesma fun√ß√£o usada pelos pedidos normais
        carregarPedidos();

        form.reset();
        enderecoFields.classList.add("hidden");
        novoPedidoModal.classList.add("hidden");
        novoPedidoModal.classList.remove("flex");

      } catch (err) {
        console.error(err);
        Swal.fire("Erro", "N√£o foi poss√≠vel criar o pedido.", "error");
      }
    });

    abrirCaixaBtn.addEventListener("click", abrirCaixa);
    fecharCaixaBtn.addEventListener("click", fecharCaixa);

    // Inicializa
    atualizarStatusCaixa();
    carregarPedidos();
  </script>
</body>
</html>
